<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Data Fields</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Styles -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="app">
    <!-- ===== Topbar: Hauptnavigation (schwebend, abgerundet) ===== -->
    <header class="topbar" role="banner">
      <div class="topbar-inner floating rounded">
        <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar">☰</button>
        <nav class="topnav" aria-label="Primary">
          <button id="dashboardNavItem" class="topnav-item" type="button">Dashboard</button>
          <button id="systemsNavItem" class="topnav-item" type="button">Systems</button>
          <button id="dataMapNavItem" class="topnav-item" type="button">Data Map</button>
          <button id="glossaryNavItem" class="topnav-item" type="button">Glossary</button>
          <button id="adminNavItem" class="topnav-item" type="button">Admin</button>
        </nav>
      </div>
    </header>

    <!-- ===== Sidebar ===== -->
    <aside class="sidebar">
      <div class="sidebar-inner">
        <div class="sidebar-head">
          <div class="sidebar-title">Navigation</div>
        </div>
        <ul id="systemList" class="sidebar-list"></ul>

        <!-- Data Map Submenu (nur im Data Map-Mode sichtbar) -->
        <ul id="dataMapSubnav" class="sidebar-list" style="display:none">
          <li><button class="map-view-filter is-active" data-view="system">System-View</button></li>
          <li><button class="map-view-filter" data-view="dataobject">Data Object-View</button></li>
        </ul>

        <!-- Glossary Submenu (nur im Glossary-Mode sichtbar) -->
        <ul id="glossarySubnav" class="sidebar-list" style="display:none">
          <li><button class="gls-filter" data-type="ALL">All Definitions</button></li>
          <li><button class="gls-filter" data-type="Field">Field</button></li>
          <li><button class="gls-filter" data-type="Term">Term</button></li>
          <li><button class="gls-filter" data-type="KPI">KPI</button></li>
          <li><button class="gls-filter" data-type="Process">Process</button></li>
          <li><button class="gls-filter" data-type="System">System</button></li>
        </ul>
      </div>
    </aside>

    <!-- ===== Main ===== -->
    <main class="main">

      <!-- ===== Dashboard View ===== -->
      <section id="dashboardView" class="panel" style="display:none">
        <div class="dashboard-container">
          <!-- Dashboard Header -->
          <div class="dashboard-header">
            <h2 class="dashboard-title">Dashboard</h2>
            <div class="dashboard-actions">
              <button id="dashboardRefresh" class="btn btn--secondary" title="Refresh Data">
                <span>↻ Refresh</span>
              </button>
            </div>
          </div>

          <!-- Filter Bar -->
          <div class="dashboard-filters">
            <div class="filter-group">
              <label for="dashFilterSystem">System:</label>
              <select id="dashFilterSystem" class="filter-select">
                <option value="">All Systems</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="dashFilterDomain">Domain:</label>
              <select id="dashFilterDomain" class="filter-select">
                <option value="">All Domains</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="dashFilterDataObject">Data Object:</label>
              <select id="dashFilterDataObject" class="filter-select">
                <option value="">All Data Objects</option>
              </select>
            </div>
            <button id="dashResetFilters" class="btn btn--ghost btn--sm">Clear Filters</button>
          </div>

          <!-- Metrics Grid -->
          <div class="dashboard-metrics">
            <!-- Systems Metrics -->
            <div class="metric-card" data-metric="systems">
              <div class="metric-header">
                <h3 class="metric-title">Systems</h3>
              </div>
              <div class="metric-content">
                <div class="metric-row">
                  <span class="metric-label">Global Tools</span>
                  <span class="metric-value metric-clickable" id="metricGlobalSystems" data-filter="global-systems">0</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Local Tools</span>
                  <span class="metric-value metric-clickable" id="metricLocalSystems" data-filter="local-systems">0</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Total Systems</span>
                  <span class="metric-value metric-value--primary metric-clickable" id="metricTotalSystems" data-filter="all-systems">0</span>
                </div>
              </div>
            </div>

            <!-- Fields Metrics -->
            <div class="metric-card" data-metric="fields">
              <div class="metric-header">
                <h3 class="metric-title">Data Fields</h3>
              </div>
              <div class="metric-content">
                <div class="metric-row">
                  <span class="metric-label">Global Fields</span>
                  <span class="metric-value metric-clickable" id="metricGlobalFields" data-filter="global-fields">0</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Local Fields</span>
                  <span class="metric-value metric-clickable" id="metricLocalFields" data-filter="local-fields">0</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Total Fields</span>
                  <span class="metric-value metric-value--primary metric-clickable" id="metricTotalFields" data-filter="all-fields">0</span>
                </div>
              </div>
            </div>

            <!-- Definitions Metrics -->
            <div class="metric-card" data-metric="definitions">
              <div class="metric-header">
                <h3 class="metric-title">Definitions</h3>
              </div>
              <div class="metric-content">
                <div class="metric-row">
                  <span class="metric-label">With Definition</span>
                  <span class="metric-value metric-clickable" id="metricWithDef" data-filter="with-definition">0</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Without Definition</span>
                  <span class="metric-value metric-clickable" id="metricWithoutDef" data-filter="without-definition">0</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Coverage</span>
                  <span class="metric-value metric-value--primary" id="metricDefCoverage">0%</span>
                </div>
              </div>
            </div>

            <!-- Glossary Metrics -->
            <div class="metric-card" data-metric="glossary">
              <div class="metric-header">
                <h3 class="metric-title">Glossary</h3>
              </div>
              <div class="metric-content">
                <div class="metric-row">
                  <span class="metric-label">Total Terms</span>
                  <span class="metric-value metric-value--primary metric-clickable" id="metricGlossaryTerms" data-filter="all-glossary">0</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Linked Fields</span>
                  <span class="metric-value metric-clickable" id="metricLinkedFields" data-filter="linked-fields">0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts Section -->
          <div class="dashboard-charts">
            <!-- Data Objects Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3 class="chart-title">Data Objects Distribution</h3>
                <button class="chart-details-btn" data-chart="dataObjects">Details ›</button>
              </div>
              <div class="chart-body">
                <canvas id="chartDataObjects"></canvas>
              </div>
            </div>

            <!-- Field Definitions Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3 class="chart-title">Field Definitions Coverage</h3>
                <button class="chart-details-btn" data-chart="definitions">Details ›</button>
              </div>
              <div class="chart-body">
                <canvas id="chartDefinitions"></canvas>
              </div>
            </div>

            <!-- Systems by Domain Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3 class="chart-title">Systems by Domain</h3>
                <button class="chart-details-btn" data-chart="domains">Details ›</button>
              </div>
              <div class="chart-body">
                <canvas id="chartDomains"></canvas>
              </div>
            </div>
          </div>

          <!-- Details Table (initially hidden) -->
          <div id="dashboardDetails" class="dashboard-details" style="display:none">
            <div class="details-header">
              <h3 id="detailsTitle" class="details-title">Details</h3>
              <button id="closeDetails" class="btn btn--ghost btn--sm">Close</button>
            </div>
            <div class="details-body">
              <table class="table">
                <thead id="detailsTableHead"></thead>
                <tbody id="detailsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Top Tabs for Systems view ===== -->
      <div id="topTabs" class="top-tabs">
        <button class="tab is-active" data-tab="global">Global Data Fields</button>
        <button class="tab" data-tab="local">Local Data Fields</button>
        <button class="tab" data-tab="mappings">Mappings</button>
      </div>

      <!-- ===== GLOBAL ===== -->
      <section id="global" class="panel is-active">
        <div class="section-head">
          <h2 class="section-title">Global Data Fields</h2>
          <div class="section-actions">
            <button id="btnGlobalFilter" class="btn btn--secondary" type="button" title="Filter"><span>Filter</span></button>
            <button id="btnGlobalNew" class="btn btn--primary" type="button" title="New"><span>New</span></button>
            <button id="btnGlobalExport" class="btn btn--secondary" type="button" title="Export"><span>Export</span></button>
          </div>
        </div>

        <div class="panel-body">
          <table class="table">
            <thead></thead>
            <tbody id="fieldsBody"></tbody>
          </table>
        </div>
      </section>

      <!-- ===== LOCAL ===== -->
      <section id="local" class="panel" style="display:none">
        <div class="section-head">
          <h2 class="section-title">Local Data Fields</h2>
          <div class="section-actions">
            <button id="btnLocalFilter" class="btn btn--secondary" type="button" title="Filter"><span>Filter</span></button>
            <button id="btnLocalNew" class="btn btn--primary" type="button" title="New"><span>New</span></button>
            <button id="btnLocalExport" class="btn btn--secondary" type="button" title="Export"><span>Export</span></button>
          </div>
        </div>

        <!-- Hier rendert JS die Tabellen -->
        <div id="localTables" class="panel-body local-tables"></div>
      </section>

      <!-- ===== MAPPINGS (NEU) ===== -->
      <section id="mappings" class="panel" style="display:none">
        <div id="systems-mappings-section" class="block" aria-label="Field Mappings">
          <div class="section-head">
            <h2 class="section-title">Mappings (per Legal Entity & System)</h2>
            <div class="section-actions">
              <button id="addMappingBtn" class="btn btn--primary" type="button">+ New Mapping</button>
            </div>
          </div>

          <div class="panel-body">
            <div class="filters-row">
              <label>Legal Entity
                <select id="mapFilterLE"></select>
              </label>
              <label>System
                <select id="mapFilterSystem"></select>
              </label>
              <label>Data Object
                <select id="mapFilterDO"></select>
              </label>
            </div>

            <table id="mappingsTable" class="table table--mappings">
              <thead>
                <tr>
                  <th style="width:12%">Legal Entity</th>
                  <th style="width:16%">System</th>
                  <th style="width:18%">Local Field</th>
                  <th style="width:18%">Global Field</th>
                  <th style="width:18%">Local Field Content</th>
                  <th style="width:18%">Global Field Content</th>
                  <th style="width:10%">Status</th>
                  <th style="width:10%">Actions</th>
                </tr>
              </thead>
              <tbody id="mappingsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ===== Glossary ===== -->
      <section id="glossaryView" class="panel" style="display:none">
        <div class="panel-head">
          <div style="display: flex; align-items: center; gap: 16px;">
            <h3 class="panel-title">Global Glossary</h3>
            <span id="glossaryVersionDisplay" style="font-size: 0.9rem; color: var(--text-dim); font-weight: 500;">Version 1.0</span>
          </div>
          <button id="addGlossaryBtn" class="btn btn--primary"><span class="plus"></span> New</button>
        </div>
        
        <!-- Glossary Tabs -->
        <div class="glossary-tabs">
          <button class="glossary-tab is-active" data-glossary-tab="current">Glossary</button>
          <button class="glossary-tab" data-glossary-tab="changes">Changes</button>
        </div>
        
        <!-- Current Glossary View -->
        <div id="glossaryCurrentView" class="panel-body">
          <table class="table">
            <thead>
              <tr id="glossaryHeadRow"></tr>
            </thead>
            <tbody id="glossaryTable"></tbody>
          </table>
        </div>
        
        <!-- Changes View -->
        <div id="glossaryChangesView" class="panel-body" style="display: none;">
          <table class="table">
            <thead>
              <tr>
                <th>Version</th>
                <th>Date</th>
                <th>Term</th>
                <th>Change Type</th>
                <th>Field</th>
                <th>Old Value</th>
                <th>New Value</th>
              </tr>
            </thead>
            <tbody id="glossaryChangesTable"></tbody>
          </table>
        </div>
      </section>

      <!-- ===== Admin Tabs ===== -->
      <div id="adminTabs" class="admin-tabs" style="display:none">
        <button class="tab is-active" data-admin-tab="admin-domains">Data Domains</button>
        <button class="tab" data-admin-tab="admin-systems">Systems</button>
        <button class="tab" data-admin-tab="admin-legal">Legal Entities</button>
        <button class="tab" data-admin-tab="admin-dataObjects">Data Objects</button>
        <button class="tab" data-admin-tab="admin-columns">Field Information</button>
      </div>

      <!-- ===== Admin: Systems ===== -->
      <section id="admin-systems" class="panel admin-view" style="display:none">
        <div class="panel-head">
          <h3 class="panel-title">Systems</h3>
          <button id="addSystemBtn" class="btn btn--primary"><span class="plus"></span> New</button>
        </div>
        <div class="panel-body">
          <table class="table">
            <thead>
              <tr>
                <th>Name</th><th>Owner</th><th>Version</th><th>Scope</th><th>Data Domain</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="systemsTable"></tbody>
          </table>
        </div>
      </section>

      <!-- ===== Admin: Data Objects ===== -->
      <div id="admin-dataObjects" class="admin-view" style="display:none">
        <div class="panel">
          <div class="panel-head">
            <div class="panel-title">Data Objects</div>
            <button class="btn btn--primary" onclick="addDataObject()">
              <span class="plus"></span> New
            </button>
          </div>
          <div class="panel-body">
            <table id="dataObjectsTable" class="table"></table>
          </div>
        </div>
      </div>

      <!-- ===== Admin: Field Information (Columns) ===== -->
      <section id="admin-columns" class="panel admin-view" style="display:none">
        <div class="panel-head">
          <h3 class="panel-title">Field Information (Columns)</h3>
          <button id="addColumnBtn" class="btn btn-primary"><span class="plus"></span> New</button>
        </div>
        <div class="panel-body">
          <table class="table">
            <thead>
              <tr>
                <th>Name</th><th>Visible</th><th>Order</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="columnsTable"></tbody>
          </table>
        </div>
      </section>

      <!-- ===== Admin: Data Domains ===== -->
      <section id="admin-domains" class="panel admin-view" style="display:none">
        <div class="panel-head">
          <h3 class="panel-title">Data Domains</h3>
          <button id="addDomainBtn" class="btn btn--primary"><span class="plus"></span> New</button>
        </div>
        <div class="panel-body">
          <table class="table">
            <thead>
              <tr>
                <th>Domain</th><th>Manager</th><th>Active</th><th>Color</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="domainsTable"></tbody>
          </table>
        </div>
      </section>

      <!-- ===== Admin: Legal Entities ===== -->
      <section id="admin-legal" class="panel admin-view" style="display:none">
        <div class="panel-head">
          <h3 class="panel-title">Legal Entities</h3>
          <button id="addLegalBtn" class="btn btn--primary"><span class="plus"></span> New</button>
        </div>
        <div class="panel-body">
          <table class="table">
            <thead>
              <tr>
                <th>LE-Number</th><th>LE Name</th><th>Country</th><th>Systems</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="legalTable"></tbody>
          </table>
        </div>
      </section>

      <!-- ===== Data Map ===== -->
      <section id="mapView" class="panel" style="display:none">
        <div class="panel-head">
          <h3 class="panel-title">Data Map</h3>
          <div class="data-map-toolbar">
            <button id="openFilterPanel" class="btn btn--secondary">Set Filters</button>
            <button id="mapFitBtn" class="btn btn--secondary">Fit to view</button>
          </div>
        </div>
        <div class="panel-body">
          <div id="mapCanvas">
            <div id="mapViewport">
              <svg id="mapEdges"></svg>
              <div id="mapNodes"></div>
            </div>
          </div>
        </div>
      </section>

      <footer class="main-footer">
        <button id="resetAllAppData" class="btn btn--ghost btn--sm">Reset App Data</button>
      </footer>

    </main>
  </div>

  <!-- ===== Filter Overlay ===== -->
  <div id="filterOverlay" class="overlay" data-filter-sheet aria-hidden="true">
    <div class="overlay-backdrop">
      <div class="overlay-card">
        <div class="overlay-head">
          <h3 class="panel-title">Set Filters</h3>
          <button id="filterCloseBtn" class="btn btn--secondary">Close</button>
        </div>
        <div class="overlay-body">
          <div class="filters-grid">
            <div class="filter-block">
              <h4>Systems</h4>
              <div id="chipSystems" class="chips"></div>
            </div>
            <div class="filter-block">
              <h4>Data Domains</h4>
              <div id="chipDomains" class="chips"></div>
            </div>
          </div>
          <div class="filter-row">
            <label for="mapSearch" style="color:var(--text-dim)">Search</label>
            <input id="mapSearch" type="text" placeholder="Search field name…" />
            <label class="chip"><input id="scopeGlobal" type="checkbox" checked /><span>Global</span></label>
            <label class="chip"><input id="scopeLocal" type="checkbox" checked /><span>Local</span></label>
          </div>
        </div>
        <div class="overlay-foot">
          <button id="filterClear" class="btn btn--secondary">Clear all</button>
          <button id="filterDone" class="btn btn--secondary">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Dialogs ===== -->

  <!-- Data Object Dialog -->
  <dialog id="dataObjectDialog">
    <div class="dialog-card">
      <div class="dialog-head">
        <div class="panel-title">New / Edit Data Object</div>
      </div>
      <form id="dataObjectForm">
        <div class="dialog-body">
          <div class="dialog-grid">
            <label for="dbo-id">ID</label>
            <input id="dbo-id" name="id" type="number" min="1" required />

            <label for="dbo-name">Name</label>
            <input id="dbo-name" name="name" type="text" required />

            <label for="dbo-domain">Data Domain</label>
            <select id="dbo-domain" name="domain" required></select>
          </div>
        </div>
        <div class="dialog-foot">
          <button class="btn-cancel" type="button">Cancel</button>
          <button class="btn btn--primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Field Dialog -->
  <dialog id="fieldDialog">
    <div class="dialog-card">
      <div class="dialog-head">
        <div class="panel-title">New / Edit Field</div>
      </div>

      <form id="fieldForm">
        <div class="dialog-body">
          <div class="dialog-grid">
            <label for="fld-name">Field Name</label>
            <input id="fld-name" name="name" type="text" required />

            <label for="fld-system">System</label>
            <select id="fld-system" name="system" required></select>

            <label for="fld-mandatory">Mandatory</label>
            <input id="fld-mandatory" name="mandatory" type="checkbox" />

            <label for="fld-local">Local Field</label>
            <label class="checkbox-inline">
              <input id="fld-local" name="local" type="checkbox" />
              <span>Visible only in local scope</span>
            </label>

            <label for="fld-mapping">Mapping</label>
            <input id="fld-mapping" name="mapping" type="text" />

            <label for="fld-foundation">Data Object</label>
            <select id="fld-foundation" name="foundationObject"></select>

            <label for="fld-glossary">Glossary Term</label>
            <select id="fld-glossary" name="glossaryId"></select>

            <!-- Legal Entity -->
            <label for="fld-legal-entity">Legal Entity</label>
            <select id="fld-legal-entity" name="legalEntityNumber">
              <option value="">(none)</option>
            </select>

            <label for="fld-source-system">Source System</label>
            <select id="fld-source-system" name="sourceSystem"></select>

            <label for="fld-source-field">Source Field</label>
            <select id="fld-source-field" name="sourceField" disabled>
              <option value="">Select a system first</option>
            </select>
          </div>

          <!-- === Allowed Values (ENUM) === -->
          <div class="dialog-group" style="margin-top:1rem; border-top:1px solid var(--divider); padding-top:1rem;">
            <label for="fld-allowed-values" style="grid-column:1/-1; text-align:left; font-size:12.5px; color:var(--text-dim); margin-bottom:0.5rem;">Allowed Values (ENUM)</label>
            <textarea id="fld-allowed-values" rows="4" placeholder="Active
Passive
Option 3" style="grid-column:1/-1; width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--divider); font-size:13px; font-family:inherit; resize:vertical;"></textarea>
          </div>
          <!-- === /Allowed Values === -->
        </div>

        <div class="dialog-foot">
          <button class="btn-cancel" type="button">Cancel</button>
          <button class="btn btn--primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Definition Overlay -->
  <dialog id="definitionDialog" class="modal">
    <form method="dialog" id="definitionForm">
      <h3 id="def-title">Definition</h3>
      <div class="def-content">
        <div><strong>Term:</strong> <span id="def-term">—</span></div>
        <div><strong>Definition:</strong><br><div id="def-definition">—</div></div>
        <div><strong>Owner:</strong> <span id="def-owner">—</span></div>
        <div><strong>Additional info:</strong><br><div id="def-info">—</div></div>
      </div>
      <div class="dialog-actions">
        <button class="btn-cancel" type="button">Close</button>
        <button type="button" id="def-open-glossary" class="btn btn--primary">Open in Glossary</button>
      </div>
    </form>
  </dialog>

  <!-- System Dialog -->
  <dialog id="systemDialog">
    <div class="dialog-card">
      <div class="dialog-head">
        <div class="panel-title">New / Edit System</div>
        <button class="btn-cancel" type="button">Cancel</button>
      </div>
      <form id="systemForm">
        <div class="dialog-body">
          <div class="dialog-grid">
            <label for="sys-name">Name</label>
            <input id="sys-name" name="name" type="text" required />

            <label for="sys-owner">Owner</label>
            <input id="sys-owner" name="owner" type="text" />

            <label for="sys-version">Version</label>
            <input id="sys-version" name="version" type="text" />

            <label for="sys-scope">Global/Local</label>
            <select id="sys-scope" name="scope">
              <option value="both">both</option>
              <option value="global">global</option>
              <option value="local">local</option>
            </select>

            <label for="sys-domain">Data Domain</label>
            <select id="sys-domain" name="dataDomain"></select>
          </div>
        </div>
        <div class="dialog-foot">
          <button class="btn-cancel" type="button">Cancel</button>
          <button class="btn btn--primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Legal Entity Dialog -->
  <dialog id="legalDialog">
    <div class="dialog-card">
      <div class="dialog-head">
        <div class="panel-title">New / Edit Legal Entity</div>
      </div>
      <form id="legalForm">
        <div class="dialog-body">
          <div class="dialog-grid">
            <label for="le-number">LE Number</label>
            <input id="le-number" name="number" type="text" required />

            <label for="le-name">LE Name</label>
            <input id="le-name" name="name" type="text" required />

            <label for="le-country">Country</label>
            <input id="le-country" name="country" type="text" required />
          </div>
        </div>
        <div class="dialog-foot">
          <button class="btn-cancel" type="button">Cancel</button>
          <button class="btn btn--primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Domain Dialog -->
  <dialog id="domainDialog">
    <div class="dialog-card">
      <div class="dialog-head">
        <div class="panel-title">New / Edit Data Domain</div>
      </div>
      <form id="domainForm">
        <div class="dialog-body">
          <div class="dialog-grid">
            <label for="dom-name">Domain</label>
            <input id="dom-name" name="name" type="text" required />

            <label for="dom-manager">Manager</label>
            <input id="dom-manager" name="manager" type="text" />

            <label for="dom-active">Active</label>
            <input id="dom-active" name="active" type="checkbox" />

            <label for="dom-color">Color</label>
            <input id="dom-color" name="color" type="color" value="#6a6a6a" />
          </div>
        </div>
        <div class="dialog-foot">
          <button class="btn-cancel" type="button">Cancel</button>
          <button class="btn btn--primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Glossary Dialog -->
  <dialog id="glossaryDialog">
    <div class="dialog-card">
      <div class="dialog-head">
        <div class="panel-title">New / Edit Glossary Term</div>
      </div>
      <form id="glossaryForm">
        <div class="dialog-body">
          <div class="dialog-grid">
            <label for="gls-term">Term</label>
            <input id="gls-term" name="term" type="text" required />

            <label for="gls-type">Type</label>
            <select id="gls-type" name="type">
              <option value="Field">Field</option>
              <option value="Term">Term</option>
              <option value="KPI">KPI</option>
              <option value="Process">Process</option>
              <option value="System">System</option>
            </select>

            <label for="gls-definition">Definition</label>
            <input id="gls-definition" name="definition" type="text" />

            <label for="gls-info">Additional Information</label>
            <input id="gls-info" name="info" type="text" />

            <label for="gls-owner">Responsible Process Owner</label>
            <input id="gls-owner" name="owner" type="text" />

            <label for="gls-fieldRef">Linked Data Field</label>
            <select id="gls-fieldRef" name="fieldRef"></select>
          </div>
        </div>
        <div class="dialog-foot">
          <button class="btn-cancel" type="button">Cancel</button>
          <button class="btn btn--primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Assign Systems to Legal Entity -->
  <dialog id="leSystemsDialog">
    <div class="dialog-card">
      <div class="dialog-head">
        <div class="panel-title">Assign Systems to Legal Entity</div>
      </div>
      <form id="leSystemsForm">
        <div class="dialog-body">
          <div class="dialog-grid" style="grid-template-columns: 1fr;">
            <label>Legal Entity</label>
            <div id="leSystemsLegend" style="padding-top:10px; color:var(--text-dim)"></div>

            <label>Selectable Systems (scope: local / both)</label>
            <div id="leSystemsList" class="chips"></div>
          </div>
        </div>
        <div class="dialog-foot">
          <button class="btn-cancel" type="button">Cancel</button>
          <button id="leSystemsSave" class="btn btn--secondary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Column Dialog -->
  <dialog id="columnDialog">
    <div class="dialog-card">
      <div class="dialog-head">
        <div class="panel-title">New / Edit Column</div>
      </div>
      <form id="columnForm">
        <div class="dialog-body">
          <div class="dialog-grid">
            <label for="col-name">Name</label>
            <input id="col-name" name="name" type="text" required />

            <label for="col-visible">Visible</label>
            <input id="col-visible" name="visible" type="checkbox" />

            <label for="col-order">Order</label>
            <input id="col-order" name="order" type="number" min="1" />
          </div>
        </div>
        <div class="dialog-foot">
          <button class="btn-cancel" type="button">Cancel</button>
          <button class="btn btn--primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </dialog>

  <div id="appError" class="app-error" style="display: none;"></div>

<!-- ===== Version Dialog ===== -->
<dialog id="versionDialog">
  <div class="version-dialog-card">
    <div class="version-dialog-body">
      <div class="version-dialog-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
        </svg>
      </div>
      <h3 class="version-dialog-title">Create New Version?</h3>
      <p class="version-dialog-message">Would you like to create a new version for this change?</p>
    </div>
    <div class="version-dialog-actions">
      <button id="versionDialogKeep" class="version-btn version-btn--secondary" type="button">Keep Version</button>
      <button id="versionDialogNew" class="version-btn version-btn--primary" type="button">New Version</button>
    </div>
  </div>
</dialog>

<!-- ===== Apple-Style Details Overlay ===== -->
<div id="detailsOverlay" class="details-overlay" aria-hidden="true">
  <div class="details-overlay-backdrop">
    <div class="details-overlay-card">
      <div class="details-overlay-header">
        <h3 id="detailsOverlayTitle" class="details-overlay-title">Details</h3>
        <button id="detailsOverlayClose" class="details-overlay-close" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="details-overlay-body" id="detailsOverlayBody">
        <!-- Content will be injected here -->
      </div>
    </div>
  </div>
</div>

<!-- ===== Mapping-Editor (Modal) ===== -->
<div id="mappingEditorModal" class="modal" role="dialog" aria-modal="true" hidden>
  <div class="modal-dialog">
    <!-- Kopf -->
    <header class="modal-header">
      <h3>Map Data Fields</h3>
      <button id="mapEditClose" class="icon-btn" aria-label="Schließen">✕</button>
    </header>

    <!-- Inhalt -->
    <div class="modal-body map-editor">
      <!-- 1. Local Data Field Section -->
      <div class="field-section local-section">
        <div class="field-section-header">
          <span class="field-section-title">1. Select Local Data Field</span>
        </div>
        <div class="field-row">
          <label class="field-label">Legal Entity</label>
          <select id="mapEditLE" class="field-select">
            <option value="">— Select Legal Entity —</option>
          </select>
        </div>
        <div class="field-row">
          <label class="field-label">Local Field</label>
          <select id="mapEditLocalField" class="field-select">
            <option value="">— Select Local Field —</option>
          </select>
        </div>
      </div>

      <!-- 2. Global Data Field Section -->
      <div class="field-section global-section">
        <div class="field-section-header">
          <span class="field-section-title">2. Select Global Data Field</span>
        </div>
        <div class="field-row">
          <label class="field-label">System</label>
          <select id="mapEditSystem" class="field-select">
            <option value="">— Select System —</option>
          </select>
        </div>
        <div class="field-row">
          <label class="field-label">Global Field</label>
          <select id="mapEditGlobalField" class="field-select">
            <option value="">— Select Global Field —</option>
          </select>
        </div>
      </div>

      <!-- ===== Map Field Content ===== -->
      <h4 class="map-pairs-title">Map Field Content</h4>

      <table class="table compact map-pairs">
        <thead>
          <tr>
            <th>Local Field Content</th>
            <th>→ Global Field Content</th>
          </tr>
        </thead>
        <tbody id="mapPairsTbody"></tbody>
      </table>

      <div class="hint-row">
        Fehlt ein globaler Wert?
        <button id="mapAddGlobalAllowedValue" type="button" class="btn btn--secondary btn--sm">
          + Neuen globalen Wert anlegen
        </button>
      </div>
    </div>

    <!-- Fuß -->
    <footer class="modal-footer">
      <button id="mapEditCancel" type="button" class="btn btn--ghost">Abbrechen</button>
      <button id="mapEditSave" type="button" class="btn btn--primary">Speichern</button>
    </footer>
  </div>
</div>

  <!-- Script -->
  <script type="module" src="js/main.js"></script>
  <!-- Optional: schnelles Tab-Switching, falls nicht bereits in main.js -->
  <script>
    (function setupSystemsTabs(){
      const tabs    = document.querySelectorAll('#topTabs .tab');
      const panels  = [
        document.getElementById('global'),
        document.getElementById('local'),
        document.getElementById('mappings')
      ];
  
      function show(tabId){
        panels.forEach(p => {
          if (!p) return;
          p.style.display = (p.id === tabId) ? '' : 'none';
        });
        tabs.forEach(b => b.classList.toggle('is-active', b.dataset.tab === tabId));
      }
  
      // Klick-Handler
      tabs.forEach(btn => {
        btn.addEventListener('click', () => show(btn.dataset.tab));
      });
  
      // Initialzustand (nur "global" sichtbar)
      show('global');
  
      // global zugänglich machen, falls du woanders umschalten willst
      window.__showSystemsTab = show;
    })();
  </script>
<script>
  (function guardSystemsPanels(){
    const IDs = ['global','local','mappings'];
    const panels = IDs.map(id => document.getElementById(id));

    function hideSystemsPanels(){
      panels.forEach(p => { if (p) p.style.display = 'none'; });
    }

    function onMainViewChanged(){
      // Wenn die Systems-Untertabs (TopTabs) nicht sichtbar sind -> alles verstecken
      const topTabs = document.getElementById('topTabs');
      const systemsTabsVisible = !!(topTabs && topTabs.offsetParent);
      if (!systemsTabsVisible) hideSystemsPanels();
    }

    // Auf Klicks der Hauptnavigation hören
    ['systemsNavItem','dataMapNavItem','glossaryNavItem','adminNavItem'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('click', () => setTimeout(onMainViewChanged, 0));
    });

    // Auch auf ein eigenes Event hören (siehe Schritt 2)
    document.addEventListener('gdf:close-mapping-modal', onMainViewChanged);

    // öffentlich (falls du es woanders aufrufen willst)
    window.__hideSystemsPanels = hideSystemsPanels;
  })();
</script>

  </body>
  </html>